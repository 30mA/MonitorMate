<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=800">
	<link rel="icon" href="./images/favicon16.png" type="image/png">
	<link rel="stylesheet" href="./css/monitormate.css" type="text/css">
	<!--<link rel="stylesheet" href="./css/zebra.css" type="text/css">-->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script src="http://code.highcharts.com/highcharts.js"></script>
	<!--<script type="text/javascript" src="./js/zebra_datepicker.js"></script>-->
	<script src="./config/config.php"></script>
	<script src="./js/monitormate.js"></script>
	<title>MonitorMate â€” Historical</title>
</head>
<body>
	<h2>Historical Production/Usage:</h2>
	<div class="bottom-double-charts">
		<div id="years_chart" class="left-chart"></div>
		<div id="months_chart" class="right-chart"></div>
	</div>
	<div id="month_days_chart" class="bottom-wide-chart"></div>
	<p>
		<form action="javascript:void(0)" method="get">
			<div style="text-align: center;">
				<input id="datepicker" class="datepicker" type="text" value="" readonly="true" hidden="true">
				<button onclick="change_day(-1)">Prev</button><button onclick="change_day(0)">Today</button><button onclick="change_day(1)">Next</button>
			</div>
		</form>
	</p>
	<div id="left-col" style="height: 240px;">
		<div id="status" class="status_content"></div>
	</div>
	<div class="right-col">
		<div id="flexnet_soc" class="multichart"></div>
	</div>
	<h2>Input/Output:</h2>
	<div id="flexnet_shunts" class="bottom-wide-chart"></div>
	<h2>Battery Voltage:</h2>
	<div id="battery_volts" class="bottom-wide-chart"></div>
	<h2>PV Charge Power:</h2>
	<div id="charge_power" class="bottom-wide-chart"></div>
	<h2>PV Charge Current:</h2>
	<div id="charge_current" class="bottom-wide-chart"></div>
	<h2>PV Array Volts:</h2>
	<div id="array_volts" class="bottom-wide-chart"></div>
	<h2>PV Array Current:</h2>
	<div id="array_current" class="bottom-wide-chart"></div>

	<script>
		
		var displayDate;
		
		function refresh_data() {

//			// FIXME: check if i need to redraw the charts, it's a waste of time otherwise.
//			var chartDate = null;
//
//			if (displayDate != get_formatted_date()) {	// if the date isn't today
//				chartDate = displayDate;
//			}
//
//			// FIXME: I should make the charting functions do a setData instead of replotting from scratch
//			chart_years(chartDate, 'set');
//			chart_months(chartDate, 'set');
//			chart_days_of_month(chartDate, 'set');

			get_dataStream(displayDate);

			set_status("status", "summary");
			draw_chart('flexnet_soc','flexnet_soc');
			draw_chart('flexnet_shunts','flexnet_shunts');
			draw_chart('battery_volts','battery_volts');
			draw_chart('charge_power','charge_power');
			draw_chart('charge_current','charge_current');
			draw_chart('array_volts','array_volts');
			draw_chart('array_current','array_current');
		}		


		function change_day(delta) {

			var delta = parseInt(delta);
			var queryString;

			if (delta == 0) {
				displayDate = get_formatted_date();
				update_URL('historical.html');
				refresh_data();
			} else {
				split_date = displayDate.split(/[- :]/);
				new_date = new Date(parseInt(split_date[0]), parseInt(split_date[1] - 1), parseInt(split_date[2]));
				updated_date = new Date(new_date.getTime() + (delta * 86400000)); // one day in milliseconds
				
				if (updated_date < (new Date())) {	// make you're not sneaking into the future.
					displayDate = get_formatted_date(updated_date);
					update_URL('historical.html', displayDate);
					refresh_data();
				} else {
					alert("You can't predict the future...");
				}			
			}
			

		}


		function load_page() {
		
			var URLvars = get_URLvars();

			if (URLvars.date) {
				// put the date from the querystring into the text field
				displayDate = URLvars.date;
			} else {
				// put today into the text field
				displayDate = get_formatted_date();
			}
			
			// these should move into refresh_data()
			chart_years();
			chart_months();
			chart_days_of_month();
												
			refresh_data();
			//setInterval("get_status()", 5000);		
		}

	</script>
</body>
</html>
